import n from"compromise";function t(){return t=Object.assign||function(n){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(n[e]=o[e])}return n},t.apply(this,arguments)}var o,e=function(n,t){return n.reduce(function(n,o){return n[o]=t(n,o),n},{})},i={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},r=((o={})[i.n]=["north","go north"],o[i.e]=["east","go east"],o[i.w]=["west","go west"],o[i.s]=["south","go south"],o[i.up]=["u","go up","ascend"],o[i.down]=["d","go down","descend"],o[i.in]=["enter","go in","get in"],o[i.out]=["leave","go out","get out","exit"],o[i.look]=["look around","where","where am i","whereami"],o[i.examine]=["look at","inspect","x","ex","search","check"],o[i.get]=["g","take","pick up","obtain","acquire","grab"],o[i.drop]=["put down","toss","remove","discard"],o[i.inventory]=["inv","carrying","equipment","items","gear"],o[i.help]=["instructions","howto","how to play","?","commands","verbs","words","controls"],o),u={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."},a={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"},s=function(n){var t=n.UI,o=n.gameState,e=[],i=!1,r=function n(){if(!i){if(0===e.length)return i=!1,void(o.isActive&&t.showInput());i=!0;var r=e.shift();"pauseTime"in r?setTimeout(function(){i=!1,n()},r.pauseTime):(t.writeOutput(r.outputText,r.cssClass),t.scrollToBottom(),i=!1,n())}};return{add:function(n){e.push(n),r()}}},c=Object.freeze({SILENT:"silent",INVISIBLE:"invisible",FIXED:"fixed",QUIET:"quiet",SCENERY:"scenery"}),d=function(n,t){return n.map(function(n){return t.dyntext(n.summary)}).join(", ")},f={start:function(o){var f,p,l=function(o){var u=t({},i),a=t({},r);o.commands&&Object.entries(o.commands).forEach(function(n){var t=n[0],o=n[1];u[t]=t,a[t]=o});var s=e(Object.keys(a),function(n,t){return a[t].forEach(function(o){n[o]=t}),t});return n.extend(function(n,t){var o=e(Object.keys(s),function(){return"Verb"});t.addWords(o)}),{commands:u,aliases:a,baseCommandMap:s,nlp:n}}(o),m=l.commands,v=l.aliases,g=l.baseCommandMap,I=function(t){var o,i={},r=t.entities.reduce(function(n,e,u){var a=e(function(){return r[a.id]});if(!a.id)throw console.error(a),new Error("Missing entity id");return a.is=function(n){return a.id===n},a.exists=!0,a.meta={visitCount:0,isInitialState:!0,isExamined:!1},a.data||(a.data={}),a.things||(a.things=[]),a.tags||(a.tags=[]),a.things=new Set(a.things),a.tags=new Set(a.tags),a.nouns&&a.nouns.forEach(function(n){if(n in i)throw new Error("Duplicate noun '"+n+"' found for entity '"+a.id+"'");i[n]=a.id}),n[a.id]=a,0===u&&(o=t.startLocationId||a.id),n},{});return n.extend(function(n,t){var o=e(Object.keys(i),function(){return"Noun"});t.addWords(o)}),{entities:r,baseNounMap:i,startLocationId:o,getSubject:function(n,t,o){if(void 0===o&&(o=function(){return!0}),!(n in i))return!1;t instanceof Array||(t=[t]);var e=r[i[n]],u=!1;return t.forEach(function(n){n.has(e.id)&&o(e)&&(u=e)}),u}}}(o),h=I.entities,y=I.startLocationId,T=I.getSubject,E=t({},u),L={turnCount:0,isActive:!0,currentLocationId:y,inventory:new Set(o.startInventory||[]),lastSubject:null},S=function(n){void 0===n&&(n={});var o=t({},a,n),i=e(Object.keys(o),function(n,t){var e=o[t],i=document.querySelector(e);if(!i)throw new Error("No DOM element found for selector: "+e);return i}),r=function(){return i.inputField.value.trim()};return{els:i,onSubmit:function(n){i.inputForm.addEventListener("submit",function(t){t.preventDefault(),n(r())})},getInput:r,clearInput:function(){i.inputField.value=""},hideInput:function(){i.inputForm.classList.add("hidden")},showInput:function(){i.inputForm.classList.remove("hidden")},clearOutput:function(){i.output.innerHTML=""},writeOutput:function(n,t){var o=document.createElement("p");o.innerHTML=n,t&&o.classList.add(t),i.output.appendChild(o)},scrollToBottom:function(){window.scrollTo(0,document.body.scrollHeight)}}}(),N=s({UI:S,gameState:L}),O={ALIASES:v,COMMANDS:m,clear:function(){S.clearOutput()},doTurn:function(){L.turnCount+=1},dyntext:function(n){return"function"==typeof n?n(O):n},end:function(){L.isActive=!1,S.hideInput()},entity:function(n){if(!h[n])throw new Error("Game logic error: no entity '"+n+"' found");return h[n]},goTo:function(n,t){void 0===t&&(t=!1);var e=O.entity(n),i=!1,r=null,u=function(){i=!0},a=function(n){r=n};"function"==typeof o.onGoTo&&o.onGoTo({game:O,destination:e,stopGoTo:u,afterGoTo:a}),L.isActive&&!i&&("function"==typeof e.onGoTo&&e.onGoTo({game:O,stopGoTo:u,afterGoTo:a}),L.isActive&&!i&&(L.currentLocationId=n,O.location.meta.visitCount+=1,O.look(),t||O.doTurn(),"function"==typeof r&&r()))},get inventory(){return L.inventory},get location(){return h[L.currentLocationId]},look:function(n){void 0===n&&(n=!1);for(var t=O.location,e=n||1===t.meta.visitCount,i=null,r=!1,u=function(n){i=n},a=function(){r=!0},s=[o.onLook,t.onLook],f=0;f<2;f++){var p=s[f];if("function"==typeof p&&(p({game:O,isFullLook:e,stopLook:a,afterLook:u}),r||!L.isActive))return}if(O.print(e?t.description:t.summary),0!==t.things.size){var l,m=function(n,t){return[].concat(n.things).map(function(n){return t[n]}).filter(function(n){return!n.tags.has(c.INVISIBLE)&&!n.tags.has(c.SCENERY)&&!n.tags.has(c.SILENT)})}(t,h);if(e){var v=m.filter(function(n){return n.meta.isInitialState&&n.initial});v.length>0&&(v.forEach(function(n){O.print(n.initial)}),l=v,m=m.filter(function(n){return!l.includes(n)}))}if(0!==m.length){var g=""+E.LOCATION_ITEMS_PREFIX+d(m,O)+".";O.print(g),"function"==typeof i&&(i(),i=null)}else"function"==typeof i&&(i(),i=null)}else"function"==typeof i&&(i(),i=null)},MESSAGES:E,noTurn:function(){p=!1},pause:function(n){void 0===n&&(n=0),S.hideInput(),N.add({pauseTime:n})},print:function(n,t){n&&(n instanceof Array?n.forEach(function(n){return O.print(n,t)}):N.add({outputText:O.dyntext(n),cssClass:t}))},get state(){return L},TAGS:c};S.onSubmit(function(t){t&&L.isActive&&(f=null,p=!0,O.print(t,"input"),S.clearInput(),function(t){var o=t.API,i=t.baseCommandMap,r=t.entities,u=t.commands,a=t.gameState,s=t.getSubject,f=t.config,p=t.gameMessages,l=t.afterCommand,m=n(t.inputText.toLowerCase()),v=m.verbs().out("array")[0],g=m.nouns().out("array")[0];if(!(v in i))return o.print(p.FAIL_UNKNOWN),void o.noTurn();var I=i[v],h=s(g,[o.location.things,o.inventory],function(n){return!n.tags.has(c.INVISIBLE)});if("function"==typeof f.onCommand){var y=!1,T=e(Object.keys(u),function(n,t){return I===t});if(T._base=I,f.onCommand({command:T,subject:h||{is:function(){return!1},exists:!1},game:o,stopCommand:function(n){void 0===n&&(n=!1),y=!0,n&&o.noTurn()},afterCommand:l,noTurn:o.noTurn}),y)return}if(a.isActive)if(o.location.to&&I in o.location.to)o.goTo(o.location.to[I]);else switch(I){case u.n:case u.s:case u.e:case u.w:case u.up:case u.down:case u.in:case u.out:return void o.print(p.FAIL_NO_EXIT);case u.look:return o.look(!0),void o.noTurn();case u.examine:return h?(o.print(h.description),void(h.meta.isExamined=!0)):(o.print(p.FAIL_EXAMINE),void o.noTurn());case u.get:return function(n){return n&&!n.tags.has(c.SCENERY)&&!n.tags.has(c.FIXED)}(h)?o.inventory.has(h.id)?(o.print(p.FAIL_GET_OWNED),void o.noTurn()):(o.location.things.delete(h.id),o.inventory.add(h.id),h.meta.isInitialState=!1,void o.print(p.OK_GET)):(o.print(p.FAIL_GET),void o.noTurn());case u.drop:return h&&o.inventory.has(h.id)?h.tags.has(c.FIXED)?(o.print(p.FAIL_DROP),void o.noTurn()):(o.inventory.delete(h.id),o.location.things.add(h.id),h.meta.isInitialState=!1,void o.print(p.OK_DROP)):(o.print(p.FAIL_DROP_OWNED),void o.noTurn());case u.inventory:if(0===o.inventory.size)return o.print(p.INV_NONE),void o.noTurn();var E=function(n,t){return[].concat(t.inventory).map(function(t){return n[t]}).filter(function(n){return!n.tags.has(c.INVISIBLE)&&!n.tags.has(c.SILENT)})}(r,o),L=d(E,o);return o.print(""+p.INV_PREFIX+L+"."),void o.noTurn();case u.help:return o.print("Basic commands: "+Object.values(u).join(", ")+". Try other words too!","info"),void o.noTurn();default:o.print(p.FAIL_UNHANDLED),o.noTurn()}}({inputText:t,API:O,baseCommandMap:g,entities:h,commands:m,gameState:L,getSubject:T,config:o,gameMessages:E,afterCommand:function(n){f=n}}),L.isActive&&("function"==typeof f&&(f(),f=null),L.isActive&&p&&(O.doTurn(),"function"==typeof o.onTurn&&o.onTurn({game:O,turnCount:L.turnCount}))))}),S.clearOutput(),O.goTo(L.currentLocationId,!0)}};export{f as default};
//# sourceMappingURL=index.esm.js.map
