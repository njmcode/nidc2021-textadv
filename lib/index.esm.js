import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var o=arguments[n];for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(t[e]=o[e])}return t},n.apply(this,arguments)}var o,e={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},i=((o={})[e.n]=["north","go north"],o[e.e]=["east","go east"],o[e.w]=["west","go west"],o[e.s]=["south","go south"],o[e.up]=["u","go up","ascend"],o[e.down]=["d","go down","descend"],o[e.in]=["enter","go in","get in"],o[e.out]=["leave","go out","get out","exit"],o[e.look]=["look around","where","where am i","whereami"],o[e.examine]=["look at","inspect","x","ex","search","check"],o[e.get]=["g","take","pick up","obtain","acquire","grab"],o[e.drop]=["put down","toss","remove","discard"],o[e.inventory]=["inv","carrying","equipment","items","gear"],o[e.help]=["instructions","howto","how to play","?","commands","verbs","words","controls"],o),r={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."},a={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"},u=function(t){var n=t.UI,o=t.gameState,e=[],i=!1,r=function t(){if(!i){if(0===e.length)return i=!1,void(o.isActive&&n.showInput());i=!0;var r=e.shift();"pauseTime"in r?setTimeout(function(){i=!1,t()},r.pauseTime):(n.writeOutput(r.outputText,r.cssClass),n.scrollToBottom(),i=!1,t())}};return{add:function(t){e.push(t),r()}}},s=Object.freeze({SILENT:"silent",INVISIBLE:"invisible",FIXED:"fixed",QUIET:"quiet",SCENERY:"scenery"}),c={start:function(o){var c,d,f=function(o){var r=n({},e),a=n({},i);o.commands&&Object.entries(o.commands).forEach(function(t){var n=t[0],o=t[1];r[n]=n,a[n]=o});var u=Object.entries(a).reduce(function(t,n){var o=n[0],e=n[1];return t[o]=o,e.forEach(function(n){t[n]=o}),t},{});return t.extend(function(t,n){var o=Object.keys(u).reduce(function(t,n){return t[n]="Verb",t},{});n.addWords(o)}),{commands:r,aliases:a,baseCommandMap:u,nlp:t}}(o),p=f.commands,m=f.aliases,l=f.baseCommandMap,v=function(n){var o,e={},i=n.entities.reduce(function(t,r,a){var u=r(function(){return i[u.id]});if(!u.id)throw console.error(u),new Error("Missing entity id");return u.is=function(t){return u.id===t},u.exists=!0,u.meta={visitCount:0,isInitialState:!0,isExamined:!1},u.nouns&&u.nouns.forEach(function(t){if(t in e)throw new Error("Duplicate noun '"+t+"' found for entity '"+u.id+"'");e[t]=u.id}),u.data||(u.data={}),u.things||(u.things=[]),u.tags||(u.tags=[]),u.things=new Set(u.things),u.tags=new Set(u.tags),t[u.id]=u,0===a&&(o=n.startLocationId||u.id),t},{});return t.extend(function(t,n){var o=Object.keys(e).reduce(function(t,n){return t[n]="Noun",t},{});n.addWords(o)}),{entities:i,baseNounMap:e,startLocationId:o,getSubject:function(t,n,o){if(void 0===o&&(o=function(){return!0}),!(t in e))return!1;n instanceof Array||(n=[n]);var r=i[e[t]],a=!1;return n.forEach(function(t){t.has(r.id)&&o(r)&&(a=r)}),a}}}(o),g=v.entities,I=v.startLocationId,h=v.getSubject,T=n({},r),y={turnCount:0,isActive:!0,currentLocationId:I,inventory:new Set(o.startInventory||[]),lastSubject:null},E=function(t){void 0===t&&(t={});var o=n({},a,t),e=Object.entries(o).reduce(function(t,n){var o=n[0],e=n[1],i=document.querySelector(e);if(!i)throw new Error("No DOM element found for selector: "+e);return t[o]=i,t},{}),i=function(){return e.inputField.value.trim()};return{els:e,onSubmit:function(t){e.inputForm.addEventListener("submit",function(n){n.preventDefault(),t(i())})},getInput:i,clearInput:function(){e.inputField.value=""},hideInput:function(){e.inputForm.classList.add("hidden")},showInput:function(){e.inputForm.classList.remove("hidden")},clearOutput:function(){e.output.innerHTML=""},writeOutput:function(t,n){var o=document.createElement("p");o.innerHTML=t,n&&o.classList.add(n),e.output.appendChild(o)},scrollToBottom:function(){window.scrollTo(0,document.body.scrollHeight)}}}(),S=u({UI:E,gameState:y}),L={ALIASES:m,COMMANDS:p,clear:function(){E.clearOutput()},doTurn:function(){y.turnCount+=1},dyntext:function(t){return"function"==typeof t?t(L):t},end:function(){y.isActive=!1,E.hideInput()},entity:function(t){if(!g[t])throw new Error("Game logic error: no entity '"+t+"' found");return g[t]},goTo:function(t,n){void 0===n&&(n=!1);var e=L.entity(t),i=!1,r=null,a=function(){i=!0},u=function(t){r=t};"function"==typeof o.onGoTo&&o.onGoTo({game:L,destination:e,stopGoTo:a,afterGoTo:u}),y.isActive&&!i&&("function"==typeof e.onGoTo&&e.onGoTo({game:L,stopGoTo:a,afterGoTo:u}),y.isActive&&!i&&(y.currentLocationId=t,L.location.meta.visitCount+=1,L.look(),n||L.doTurn(),"function"==typeof r&&r()))},get inventory(){return y.inventory},get location(){return g[y.currentLocationId]},look:function(t){void 0===t&&(t=!1);var n=t||1===L.location.meta.visitCount;if(L.print(n?L.location.description:L.location.summary),L.location.things.size>0){var o=[].concat(L.location.things).map(function(t){return g[t]}).filter(function(t){return!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SCENERY)&&!t.tags.has(s.SILENT)});if(n){var e=o.filter(function(t){return t.meta.isInitialState&&t.initial});e.length>0&&e.forEach(function(t){L.print(t.initial)}),o=o.filter(function(t){return!e.includes(t)})}if(o.length>0){var i=""+T.LOCATION_ITEMS_PREFIX+o.map(function(t){return L.dyntext(t.summary)}).join(", ")+".";L.print(i)}}},MESSAGES:T,noTurn:function(){d=!1},pause:function(t){void 0===t&&(t=0),E.hideInput(),S.add({pauseTime:t})},print:function(t,n){t&&(t instanceof Array?t.forEach(function(t){return L.print(t,n)}):S.add({outputText:L.dyntext(t),cssClass:n}))},get state(){return y},TAGS:s};E.onSubmit(function(n){n&&y.isActive&&(c=null,d=!0,L.print(n,"input"),E.clearInput(),function(n){var o=n.API,e=n.baseCommandMap,i=n.entities,r=n.commands,a=n.gameState,u=n.getSubject,c=n.config,d=n.gameMessages,f=n.afterCommand,p=t(n.inputText.toLowerCase()),m=p.verbs().out("array")[0],l=p.nouns().out("array")[0];if(!(m in e))return o.print(d.FAIL_UNKNOWN),void o.noTurn();var v=e[m],g=u(l,[o.location.things,o.inventory],function(t){return!t.tags.has(s.INVISIBLE)});if("function"==typeof c.onCommand){var I=!1,h=Object.keys(r).reduce(function(t,n){return t[n]=v===n,t},{});if(h._base=v,c.onCommand({command:h,subject:g||{is:function(){return!1},exists:!1},game:o,stopCommand:function(t){void 0===t&&(t=!1),I=!0,t&&o.noTurn()},afterCommand:f,noTurn:o.noTurn}),I)return}if(a.isActive)if(o.location.to&&v in o.location.to)o.goTo(o.location.to[v]);else switch(v){case r.n:case r.s:case r.e:case r.w:case r.up:case r.down:case r.in:case r.out:return void o.print(d.FAIL_NO_EXIT);case r.look:return o.look(!0),void o.noTurn();case r.examine:return g?(o.print(g.description),void(g.meta.isExamined=!0)):(o.print(d.FAIL_EXAMINE),void o.noTurn());case r.get:return!g||g.tags.has(s.SCENERY)||g.tags.has(s.FIXED)?(o.print(d.FAIL_GET),void o.noTurn()):o.inventory.has(g.id)?(o.print(d.FAIL_GET_OWNED),void o.noTurn()):(o.location.things.delete(g.id),o.inventory.add(g.id),g.meta.isInitialState=!1,void o.print(d.OK_GET));case r.drop:return g&&o.inventory.has(g.id)?g.tags.has(s.FIXED)?(o.print(d.FAIL_DROP),void o.noTurn()):(o.inventory.delete(g.id),o.location.things.add(g.id),g.meta.isInitialState=!1,void o.print(d.OK_DROP)):(o.print(d.FAIL_DROP_OWNED),void o.noTurn());case r.inventory:if(0===o.inventory.size)return o.print(d.INV_NONE),void o.noTurn();var T=[].concat(o.inventory).map(function(t){return i[t]}).filter(function(t){return!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SILENT)}).map(function(t){return o.dyntext(t.summary)}).join(", ");return o.print(""+d.INV_PREFIX+T+"."),void o.noTurn();case r.help:return o.print("Basic commands: "+Object.values(r).join(", ")+". Try other words too!","info"),void o.noTurn();default:o.print(d.FAIL_UNHANDLED),o.noTurn()}}({inputText:n,API:L,baseCommandMap:l,entities:g,commands:p,gameState:y,getSubject:h,config:o,gameMessages:T,afterCommand:function(t){c=t}}),y.isActive&&("function"==typeof c&&(c(),c=null),y.isActive&&d&&(L.doTurn(),"function"==typeof o.onTurn&&o.onTurn({game:L,turnCount:y.turnCount}))))}),E.clearOutput(),L.goTo(y.currentLocationId,!0)}};export{c as default};
//# sourceMappingURL=index.esm.js.map
