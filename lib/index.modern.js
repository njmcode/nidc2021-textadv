import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},n.apply(this,arguments)}const e=(t,n)=>t.reduce((t,e)=>(t[e]=n(t,e),t),{}),o={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},i={[o.n]:["north","go north"],[o.e]:["east","go east"],[o.w]:["west","go west"],[o.s]:["south","go south"],[o.up]:["u","go up","ascend"],[o.down]:["d","go down","descend"],[o.in]:["enter","go in","get in"],[o.out]:["leave","go out","get out","exit"],[o.look]:["look around","where","where am i","whereami"],[o.examine]:["look at","inspect","x","ex","search","check"],[o.get]:["g","take","pick up","obtain","acquire","grab"],[o.drop]:["put down","toss","remove","discard"],[o.inventory]:["inv","carrying","equipment","items","gear"],[o.help]:["instructions","howto","how to play","?","commands","verbs","words","controls"]};var r={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."};const a={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"};var s=Object.freeze({SILENT:"silent",INVISIBLE:"invisible",FIXED:"fixed",QUIET:"quiet",SCENERY:"scenery"});const u=(t,n)=>t.map(t=>n.dyntext(t.summary)).join(", ");var c={start:c=>{const{commands:d,aliases:p,baseCommandMap:l}=(r=>{const a=n({},o),s=n({},i);r.commands&&Object.entries(r.commands).forEach(([t,n])=>{a[t]=t,s[t]=n});const u=e(Object.keys(s),(t,n)=>(s[n].forEach(e=>{t[e]=n}),n));return t.extend((t,n)=>{const o=e(Object.keys(u),()=>"Verb");n.addWords(o)}),{commands:a,aliases:s,baseCommandMap:u,nlp:t}})(c),{entities:m,startLocationId:g,getSubject:I}=(n=>{const o={};let i;const r=n.entities.reduce((t,e,a)=>{const s=e(()=>r[s.id]);if(!s.id)throw console.error(s),new Error("Missing entity id");return s.is=t=>s.id===t,s.exists=!0,s.meta={visitCount:0,isInitialState:!0,isExamined:!1},s.data||(s.data={}),s.things||(s.things=[]),s.tags||(s.tags=[]),s.things=new Set(s.things),s.tags=new Set(s.tags),s.nouns&&s.nouns.forEach(t=>{if(t in o)throw new Error(`Duplicate noun '${t}' found for entity '${s.id}'`);o[t]=s.id}),t[s.id]=s,0===a&&(i=n.startLocationId||s.id),t},{});return t.extend((t,n)=>{const i=e(Object.keys(o),()=>"Noun");n.addWords(i)}),{entities:r,baseNounMap:o,startLocationId:i,getSubject:(t,n,e=(()=>!0))=>{if(!(t in o))return!1;n instanceof Array||(n=[n]);const i=r[o[t]];let a=!1;return n.forEach(t=>{t.has(i.id)&&e(i)&&(a=i)}),a}}})(c),h=n({},r),f={turnCount:0,isActive:!0,currentLocationId:g,inventory:new Set(c.startInventory||[]),lastSubject:null},v=((t={})=>{const o=n({},a,t),i=e(Object.keys(o),(t,n)=>{const e=o[n],i=document.querySelector(e);if(!i)throw new Error(`No DOM element found for selector: ${e}`);return i}),r=()=>i.inputField.value.trim();return{els:i,onSubmit:t=>{i.inputForm.addEventListener("submit",n=>{n.preventDefault(),t(r())})},getInput:r,clearInput:()=>{i.inputField.value=""},hideInput:()=>{i.inputForm.classList.add("hidden")},showInput:()=>{i.inputForm.classList.remove("hidden")},clearOutput:()=>{i.output.innerHTML=""},writeOutput:(t,n)=>{const e=document.createElement("p");e.innerHTML=t,n&&e.classList.add(n),i.output.appendChild(e)},scrollToBottom:()=>{window.scrollTo(0,document.body.scrollHeight)}}})(),T=(({UI:t,gameState:n})=>{const e=[];let o=!1;const i=()=>{if(o)return;if(0===e.length)return o=!1,void(n.isActive&&t.showInput());o=!0;const r=e.shift();if("pauseTime"in r)return void setTimeout(()=>{o=!1,i()},r.pauseTime);const{outputText:a,cssClass:s}=r;t.writeOutput(a,s),t.scrollToBottom(),o=!1,i()};return{add:t=>{e.push(t),i()}}})({UI:v,gameState:f});let y,E;const S={ALIASES:p,COMMANDS:d,clear(){v.clearOutput()},doTurn(){f.turnCount+=1},dyntext:t=>"function"==typeof t?t(S):t,end(){f.isActive=!1,v.hideInput()},entity(t){if(!m[t])throw new Error(`Game logic error: no entity '${t}' found`);return m[t]},goTo(t,n=!1){const e=S.entity(t);let o=!1,i=null;const r=()=>{o=!0},a=t=>{i=t};"function"==typeof c.onGoTo&&c.onGoTo({game:S,destination:e,stopGoTo:r,afterGoTo:a}),f.isActive&&!o&&("function"==typeof e.onGoTo&&e.onGoTo({game:S,stopGoTo:r,afterGoTo:a}),f.isActive&&!o&&(f.currentLocationId=t,S.location.meta.visitCount+=1,S.look(),n||S.doTurn(),"function"==typeof i&&i()))},get inventory(){return f.inventory},get location(){return m[f.currentLocationId]},look(t=!1){const n=S.location,e=t||1===n.meta.visitCount;if(S.print(e?n.description:n.summary),0===n.things.size)return;let o=((t,n)=>[...t.things].map(t=>n[t]).filter(t=>!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SCENERY)&&!t.tags.has(s.SILENT)))(n,m);if(e){const t=o.filter(t=>t.meta.isInitialState&&t.initial);t.length>0&&(t.forEach(t=>{S.print(t.initial)}),i=t,o=o.filter(t=>!i.includes(t)))}var i;if(0===o.length)return;const r=`${h.LOCATION_ITEMS_PREFIX}${u(o,S)}.`;S.print(r)},MESSAGES:h,noTurn(){E=!1},pause(t=0){v.hideInput(),T.add({pauseTime:t})},print(t,n){t&&(t instanceof Array?t.forEach(t=>S.print(t,n)):T.add({outputText:S.dyntext(t),cssClass:n}))},get state(){return f},TAGS:s};v.onSubmit(n=>{n&&f.isActive&&(y=null,E=!0,S.print(n,"input"),v.clearInput(),(({inputText:n,API:o,baseCommandMap:i,entities:r,commands:a,gameState:c,getSubject:d,config:p,gameMessages:l,afterCommand:m})=>{const g=t(n.toLowerCase()),I=g.verbs().out("array")[0],h=g.nouns().out("array")[0];if(!(I in i))return o.print(l.FAIL_UNKNOWN),void o.noTurn();const f=i[I],v=d(h,[o.location.things,o.inventory],t=>!t.tags.has(s.INVISIBLE));if("function"==typeof p.onCommand){let t=!1;const n=(n=!1)=>{t=!0,n&&o.noTurn()},i=e(Object.keys(a),(t,n)=>f===n);if(i._base=f,p.onCommand({command:i,subject:v||{is:()=>!1,exists:!1},game:o,stopCommand:n,afterCommand:m,noTurn:o.noTurn}),t)return}if(c.isActive)if(o.location.to&&f in o.location.to)o.goTo(o.location.to[f]);else switch(f){case a.n:case a.s:case a.e:case a.w:case a.up:case a.down:case a.in:case a.out:return void o.print(l.FAIL_NO_EXIT);case a.look:return o.look(!0),void o.noTurn();case a.examine:return v?(o.print(v.description),void(v.meta.isExamined=!0)):(o.print(l.FAIL_EXAMINE),void o.noTurn());case a.get:return(t=>t&&!t.tags.has(s.SCENERY)&&!t.tags.has(s.FIXED))(v)?o.inventory.has(v.id)?(o.print(l.FAIL_GET_OWNED),void o.noTurn()):(o.location.things.delete(v.id),o.inventory.add(v.id),v.meta.isInitialState=!1,void o.print(l.OK_GET)):(o.print(l.FAIL_GET),void o.noTurn());case a.drop:return v&&o.inventory.has(v.id)?v.tags.has(s.FIXED)?(o.print(l.FAIL_DROP),void o.noTurn()):(o.inventory.delete(v.id),o.location.things.add(v.id),v.meta.isInitialState=!1,void o.print(l.OK_DROP)):(o.print(l.FAIL_DROP_OWNED),void o.noTurn());case a.inventory:{if(0===o.inventory.size)return o.print(l.INV_NONE),void o.noTurn();const t=((t,n)=>[...n.inventory].map(n=>t[n]).filter(t=>!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SILENT)))(r,o),n=u(t,o);return o.print(`${l.INV_PREFIX}${n}.`),void o.noTurn()}case a.help:return o.print(`Basic commands: ${Object.values(a).join(", ")}. Try other words too!`,"info"),void o.noTurn();default:o.print(l.FAIL_UNHANDLED),o.noTurn()}})({inputText:n,API:S,baseCommandMap:l,entities:m,commands:d,gameState:f,getSubject:I,config:c,gameMessages:h,afterCommand:t=>{y=t}}),f.isActive&&("function"==typeof y&&(y(),y=null),f.isActive&&E&&(S.doTurn(),"function"==typeof c.onTurn&&c.onTurn({game:S,turnCount:f.turnCount}))))}),v.clearOutput(),S.goTo(f.currentLocationId,!0)}};export{c as default};
//# sourceMappingURL=index.modern.js.map
