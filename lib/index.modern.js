import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},n.apply(this,arguments)}const e=(t,n)=>t.reduce((t,e)=>(t[e]=n(t,e),t),{}),o={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},i={[o.n]:["north","go north"],[o.e]:["east","go east"],[o.w]:["west","go west"],[o.s]:["south","go south"],[o.up]:["u","go up","ascend"],[o.down]:["d","go down","descend"],[o.in]:["enter","go in","get in"],[o.out]:["leave","go out","get out","exit"],[o.look]:["look around","where","where am i","whereami"],[o.examine]:["look at","inspect","x","ex","search","check"],[o.get]:["g","take","pick up","obtain","acquire","grab"],[o.drop]:["put down","toss","remove","discard"],[o.inventory]:["inv","carrying","equipment","items","gear"],[o.help]:["instructions","howto","how to play","?","commands","verbs","words","controls"]};var r={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."};const a={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"};var s=Object.freeze({FIXED:"fixed",INVISIBLE:"invisible",ITEM:"item",PRESENT:"present",SILENT:"silent"});const u=(t,n)=>t.map(t=>n.dyntext(t.summary)).join(", "),c=t=>t&&t.tags.has(s.ITEM)&&!t.tags.has(s.FIXED)&&!t.tags.has(s.INVISIBLE);var d={start:d=>{const{commands:p,aliases:l,baseCommandMap:m}=(r=>{const a=n({},o),s=n({},i);r.commands&&Object.entries(r.commands).forEach(([t,n])=>{a[t]=t,s[t]=n});const u=e(Object.keys(s),(t,n)=>(s[n].forEach(e=>{t[e]=n}),n));return t.extend((t,n)=>{const o=e(Object.keys(u),()=>"Verb");n.addWords(o)}),{commands:a,aliases:s,baseCommandMap:u,nlp:t}})(d),{entities:I,startLocationId:g,getSubject:h}=(n=>{const o={};let i;const r=n.entities.reduce((t,e,a)=>{const s=e(()=>r[s.id]);if(!s.id)throw console.error(s),new Error("Missing entity id");return s.is=t=>s.id===t,s.exists=!0,s.meta={visitCount:0,isInitialState:!0,isExamined:!1},s.data||(s.data={}),s.things||(s.things=[]),s.tags||(s.tags=[]),s.things=new Set(s.things),s.tags=new Set(s.tags),s.nouns&&s.nouns.forEach(t=>{if(t in o)throw new Error(`Duplicate noun '${t}' found for entity '${s.id}'`);o[t]=s.id}),t[s.id]=s,0===a&&(i=n.startLocationId||s.id),t},{});return t.extend((t,n)=>{const i=e(Object.keys(o),()=>"Noun");n.addWords(i)}),{entities:r,baseNounMap:o,startLocationId:i,getSubject:(t,n,e=(()=>!0))=>{if(!(t in o))return!1;n instanceof Array||(n=[n]);const i=r[o[t]];let a=!1;return n.forEach(t=>{t.has(i.id)&&e(i)&&(a=i)}),a}}})(d),f=n({},r),v={turnCount:0,isActive:!0,currentLocationId:g,inventory:new Set(d.startInventory||[]),lastSubject:null},y=((t={})=>{const o=n({},a,t),i=e(Object.keys(o),(t,n)=>{const e=o[n],i=document.querySelector(e);if(!i)throw new Error(`No DOM element found for selector: ${e}`);return i}),r=()=>i.inputField.value.trim();return{els:i,onSubmit:t=>{i.inputForm.addEventListener("submit",n=>{n.preventDefault(),t(r())})},getInput:r,clearInput:()=>{i.inputField.value=""},hideInput:()=>{i.inputForm.classList.add("hidden")},showInput:()=>{i.inputForm.classList.remove("hidden")},clearOutput:()=>{i.output.innerHTML=""},writeOutput:(t,n)=>{const e=document.createElement("p");e.innerHTML=t,n&&e.classList.add(n),i.output.appendChild(e)},scrollToBottom:()=>{window.scrollTo(0,document.body.scrollHeight)}}})(),T=(({UI:t,gameState:n})=>{const e=[];let o=!1;const i=()=>{if(o)return;if(0===e.length)return o=!1,void(n.isActive&&t.showInput());o=!0;const r=e.shift();if("pauseTime"in r)return void setTimeout(()=>{o=!1,i()},r.pauseTime);const{outputText:a,cssClass:s}=r;t.writeOutput(a,s),t.scrollToBottom(),o=!1,i()};return{add:t=>{e.push(t),i()}}})({UI:y,gameState:v});let E,L;const S={ALIASES:l,COMMANDS:p,clear(){y.clearOutput()},doTurn(){v.turnCount+=1},dyntext:t=>"function"==typeof t?t(S):t,end(){v.isActive=!1,y.hideInput()},entity(t){if(!I[t])throw new Error(`Game logic error: no entity '${t}' found`);return I[t]},goTo(t,n=!1){const e=S.entity(t);let o=!0;"function"==typeof d.onGoTo&&(o=d.onGoTo({game:S,destination:e})),!1!==o&&v.isActive&&("function"==typeof e.onGoTo&&(o=e.onGoTo({game:S})),!1!==o&&v.isActive&&(v.currentLocationId=t,S.location.meta.visitCount+=1,S.look(),n||S.doTurn(),"function"==typeof o&&o()))},get inventory(){return v.inventory},get location(){return I[v.currentLocationId]},look(t=!1){const n=S.location,e=t||1===n.meta.visitCount;let o=!0;const i=[d.onLook,n.onLook];for(let t=0;t<2;t++){const n=i[t];if("function"==typeof n&&(o=n({game:S,isFullLook:e}),!1===o||!v.isActive))return}if(S.print(e?n.description:n.summary),0===n.things.size)return void("function"==typeof o&&o());let r=((t,n)=>[...t.things].map(t=>n[t]).filter(t=>(t.tags.has(s.ITEM)||t.tags.has(s.PRESENT))&&!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SILENT)))(n,I);if(e){const t=r.filter(t=>t.meta.isInitialState&&t.initial);t.length>0&&(t.forEach(t=>{S.print(t.initial)}),a=t,r=r.filter(t=>!a.includes(t)))}var a;if(0===r.length)return void("function"==typeof o&&o());const c=`${f.LOCATION_ITEMS_PREFIX}${u(r,S)}.`;S.print(c),"function"==typeof o&&o()},MESSAGES:f,noTurn(){L=!1},pause(t=0){y.hideInput(),T.add({pauseTime:t})},print(t,n){t&&(t instanceof Array?t.forEach(t=>S.print(t,n)):T.add({outputText:S.dyntext(t),cssClass:n}))},get state(){return v},TAGS:s};y.onSubmit(n=>{n&&v.isActive&&(E=null,L=!0,S.print(n,"input"),y.clearInput(),(({inputText:n,API:o,baseCommandMap:i,entities:r,commands:a,gameState:d,getSubject:p,config:l,gameMessages:m,afterCommand:I})=>{const g=t(n.toLowerCase()),h=g.verbs().out("array")[0],f=g.nouns().out("array")[0];if(!(h in i))return o.print(m.FAIL_UNKNOWN),void o.noTurn();const v=i[h],y=p(f,[o.location.things,o.inventory],t=>!t.tags.has(s.INVISIBLE));if("function"==typeof l.onCommand){let t=!0;const n=e(Object.keys(a),(t,n)=>v===n);if(n._base=v,t=l.onCommand({command:n,subject:y||{is:()=>!1,exists:!1},game:o,noTurn:o.noTurn}),!1===t||!d.isActive)return;"function"==typeof t&&I(t)}if(o.location.to&&v in o.location.to)o.goTo(o.location.to[v]);else switch(v){case a.n:case a.s:case a.e:case a.w:case a.up:case a.down:case a.in:case a.out:return void o.print(m.FAIL_NO_EXIT);case a.look:return o.look(!0),void o.noTurn();case a.examine:return y?(o.print(y.description),void(y.meta.isExamined=!0)):(o.print(m.FAIL_EXAMINE),void o.noTurn());case a.get:return c(y)?o.inventory.has(y.id)?(o.print(m.FAIL_GET_OWNED),void o.noTurn()):(o.location.things.delete(y.id),o.inventory.add(y.id),y.meta.isInitialState=!1,void o.print(m.OK_GET)):(o.print(m.FAIL_GET),void o.noTurn());case a.drop:return y&&o.inventory.has(y.id)?c(y)?(o.inventory.delete(y.id),o.location.things.add(y.id),y.meta.isInitialState=!1,void o.print(m.OK_DROP)):(o.print(m.FAIL_DROP),void o.noTurn()):(o.print(m.FAIL_DROP_OWNED),void o.noTurn());case a.inventory:{if(0===o.inventory.size)return o.print(m.INV_NONE),void o.noTurn();const t=((t,n)=>[...n.inventory].map(n=>t[n]).filter(t=>!t.tags.has(s.INVISIBLE)&&!t.tags.has(s.SILENT)))(r,o),n=u(t,o);return o.print(`${m.INV_PREFIX}${n}.`),void o.noTurn()}case a.help:return o.print(`Basic commands: ${Object.values(a).join(", ")}. Try other words too!`,"info"),void o.noTurn();default:o.print(m.FAIL_UNHANDLED),o.noTurn()}})({inputText:n,API:S,baseCommandMap:m,entities:I,commands:p,gameState:v,getSubject:h,config:d,gameMessages:f,afterCommand:t=>{E=t}}),v.isActive&&("function"==typeof E&&(E(),E=null),v.isActive&&L&&(S.doTurn(),"function"==typeof d.onTurn&&d.onTurn({game:S,turnCount:v.turnCount}))))}),y.clearOutput(),S.goTo(v.currentLocationId,!0)}};export{d as default};
//# sourceMappingURL=index.modern.js.map
