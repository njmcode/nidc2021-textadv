import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},n.apply(this,arguments)}const e={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"},o={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},i={[o.n]:["north","go north"],[o.e]:["east","go east"],[o.w]:["west","go west"],[o.s]:["south","go south"],[o.up]:["u","go up","ascend"],[o.down]:["d","go down","descend"],[o.in]:["enter","go in","get in"],[o.out]:["leave","go out","get out","exit"],[o.look]:["look around","where","where am i","whereami"],[o.examine]:["look at","inspect","x","ex","search","check"],[o.get]:["g","take","pick up","obtain","acquire","grab"],[o.drop]:["put down","toss","remove","discard"],[o.inventory]:["inv","carrying","equipment","items","gear"],[o.help]:["instructions","howto","how to play","?","commands","verbs","words","controls"]};var r={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."},a=Object.freeze({SILENT:"silent",INVISIBLE:"invisible",FIXED:"fixed",QUIET:"quiet",SCENERY:"scenery"}),s={start:s=>{const u=((t={})=>{const o=n({},e,t),i=Object.entries(o).reduce((t,[n,e])=>{const o=document.querySelector(e);if(!o)throw new Error(`No DOM element found for selector: ${e}`);return t[n]=o,t},{}),r=()=>i.inputField.value.trim();return{els:i,onSubmit:t=>{i.inputForm.addEventListener("submit",n=>{n.preventDefault(),t(r())})},getInput:r,clearInput:()=>{i.inputField.value=""},hideInput:()=>{i.inputForm.classList.add("hidden")},showInput:()=>{i.inputForm.classList.remove("hidden")},clearOutput:()=>{i.output.innerHTML=""},writeOutput:(t,n)=>{const e=document.createElement("p");e.innerHTML=t,n&&e.classList.add(n),i.output.appendChild(e)},scrollToBottom:()=>{window.scrollTo(0,document.body.scrollHeight)}}})(),{commands:c,aliases:d,baseCommandMap:l}=(e=>{const r=n({},o),a=n({},i);e.commands&&Object.entries(e.commands).forEach(([t,n])=>{r[t]=t,a[t]=n});const s=Object.entries(a).reduce((t,[n,e])=>(t[n]=n,e.forEach(e=>{t[e]=n}),t),{});return t.extend((t,n)=>{const e=Object.keys(s).reduce((t,n)=>(t[n]="Verb",t),{});n.addWords(e)}),{commands:r,aliases:a,baseCommandMap:s,nlp:t}})(s),{entities:p,startLocationId:m,getSubject:g}=(n=>{const e={};let o;const i=n.entities.reduce((t,r,a)=>{const s=r(()=>i[s.id]);if(!s.id)throw console.error(s),new Error("Missing entity id");return s.is=t=>s.id===t,s.exists=!0,s.meta={visitCount:0,isInitialState:!0,isExamined:!1},s.nouns&&s.nouns.forEach(t=>{if(t in e)throw new Error(`Duplicate noun '${t}' found for entity '${s.id}'`);e[t]=s.id}),s.data||(s.data={}),s.things||(s.things=[]),s.tags||(s.tags=[]),s.things=new Set(s.things),s.tags=new Set(s.tags),t[s.id]=s,0===a&&(o=n.startLocationId||s.id),t},{});return t.extend((t,n)=>{const o=Object.keys(e).reduce((t,n)=>(t[n]="Noun",t),{});n.addWords(o)}),{entities:i,baseNounMap:e,startLocationId:o,getSubject:(t,n,o=(()=>!0))=>{if(!(t in e))return!1;n instanceof Array||(n=[n]);const r=i[e[t]];let a=!1;return n.forEach(t=>{t.has(r.id)&&o(r)&&(a=r)}),a}}})(s),I=n({},r),h={turnCount:0,isActive:!0,currentLocationId:m,inventory:new Set(s.startInventory||[]),lastSubject:null};let f,y;const E={ALIASES:d,COMMANDS:c,clear(){u.clearOutput()},doTurn(){h.turnCount+=1},dyntext:t=>"function"==typeof t?t(E):t,end(){h.isActive=!1,u.hideInput()},entity(t){if(!p[t])throw new Error(`Game logic error: no entity '${t}' found`);return p[t]},goTo(t,n=!1){const e=E.entity(t);let o=!1,i=null;const r=()=>{o=!0},a=t=>{i=t};"function"==typeof s.onGoTo&&s.onGoTo({game:E,destination:e,stopGoTo:r,afterGoTo:a}),h.isActive&&!o&&("function"==typeof e.onGoTo&&e.onGoTo({game:E,stopGoTo:r,afterGoTo:a}),h.isActive&&!o&&(h.currentLocationId=t,E.location.meta.visitCount+=1,E.look(),n||E.doTurn(),"function"==typeof i&&i()))},get inventory(){return h.inventory},get location(){return p[h.currentLocationId]},look(t=!1){const n=t||1===E.location.meta.visitCount;if(E.print(n?E.location.description:E.location.summary),E.location.things.size>0){let t=[...E.location.things].map(t=>p[t]).filter(t=>!t.tags.has(a.INVISIBLE)&&!t.tags.has(a.SCENERY)&&!t.tags.has(a.SILENT));if(n){const n=t.filter(t=>t.meta.isInitialState&&t.initial);n.length>0&&n.forEach(t=>{E.print(t.initial)}),t=t.filter(t=>!n.includes(t))}if(t.length>0){const n=`${I.LOCATION_ITEMS_PREFIX}${t.map(t=>E.dyntext(t.summary)).join(", ")}.`;E.print(n)}}},MESSAGES:I,noTurn(){y=!1},print(t,n){t&&(t instanceof Array?t.forEach(t=>E.print(t,n)):(u.writeOutput(E.dyntext(t),n),u.scrollToBottom()))},get state(){return h},TAGS:a};u.onSubmit(n=>{n&&h.isActive&&(f=null,y=!0,E.print(n,"input"),u.clearInput(),(({inputText:n,API:e,baseCommandMap:o,entities:i,commands:r,gameState:s,getSubject:u,config:c,gameMessages:d,afterCommand:l})=>{const p=t(n.toLowerCase()),m=p.verbs().out("array")[0],g=p.nouns().out("array")[0];if(!(m in o))return e.print(d.FAIL_UNKNOWN),void e.noTurn();const I=o[m],h=u(g,[e.location.things,e.inventory],t=>!t.tags.has(a.INVISIBLE));if("function"==typeof c.onCommand){let t=!1;const n=(n=!1)=>{t=!0,n&&e.noTurn()},o=Object.keys(r).reduce((t,n)=>(t[n]=I===n,t),{});if(o._base=I,c.onCommand({command:o,subject:h||{is:()=>!1,exists:!1},game:e,stopCommand:n,afterCommand:l,noTurn:e.noTurn}),t)return}if(s.isActive)if(e.location.to&&I in e.location.to)e.goTo(e.location.to[I]);else switch(I){case r.n:case r.s:case r.e:case r.w:case r.up:case r.down:case r.in:case r.out:return void e.print(d.FAIL_NO_EXIT);case r.look:return e.look(!0),void e.noTurn();case r.examine:return h?(e.print(h.description),void(h.meta.isExamined=!0)):(e.print(d.FAIL_EXAMINE),void e.noTurn());case r.get:return!h||h.tags.has(a.SCENERY)||h.tags.has(a.FIXED)?(e.print(d.FAIL_GET),void e.noTurn()):e.inventory.has(h.id)?(e.print(d.FAIL_GET_OWNED),void e.noTurn()):(e.location.things.delete(h.id),e.inventory.add(h.id),h.meta.isInitialState=!1,void e.print(d.OK_GET));case r.drop:return h&&e.inventory.has(h.id)?h.tags.has(a.FIXED)?(e.print(d.FAIL_DROP),void e.noTurn()):(e.inventory.delete(h.id),e.location.things.add(h.id),h.meta.isInitialState=!1,void e.print(d.OK_DROP)):(e.print(d.FAIL_DROP_OWNED),void e.noTurn());case r.inventory:{if(0===e.inventory.size)return e.print(d.INV_NONE),void e.noTurn();const t=[...e.inventory].map(t=>i[t]).filter(t=>!t.tags.has(a.INVISIBLE)&&!t.tags.has(a.SILENT)).map(t=>e.dyntext(t.summary)).join(", ");return e.print(`${d.INV_PREFIX}${t}.`),void e.noTurn()}case r.help:return e.print(`Basic commands: ${Object.values(r).join(", ")}. Try other words too!`,"info"),void e.noTurn();default:e.print(d.FAIL_UNHANDLED),e.noTurn()}})({inputText:n,API:E,baseCommandMap:l,entities:p,commands:c,gameState:h,getSubject:g,config:s,gameMessages:I,afterCommand:t=>{f=t}}),h.isActive&&("function"==typeof f&&(f(),f=null),h.isActive&&y&&(E.doTurn(),"function"==typeof s.onTurn&&s.onTurn({game:E,turnCount:h.turnCount}))))}),u.clearOutput(),E.goTo(h.currentLocationId,!0)}};export{s as default};
//# sourceMappingURL=index.modern.js.map
