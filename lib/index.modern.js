import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},n.apply(this,arguments)}const e={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},o={[e.n]:["north","go north"],[e.e]:["east","go east"],[e.w]:["west","go west"],[e.s]:["south","go south"],[e.up]:["u","go up","ascend"],[e.down]:["d","go down","descend"],[e.in]:["enter","go in","get in"],[e.out]:["leave","go out","get out","exit"],[e.look]:["look around","where","where am i","whereami"],[e.examine]:["look at","inspect","x","ex","search","check"],[e.get]:["g","take","pick up","obtain","acquire","grab"],[e.drop]:["put down","toss","remove","discard"],[e.inventory]:["inv","carrying","equipment","items","gear"],[e.help]:["instructions","howto","how to play","?","commands","verbs","words","controls"]};var i={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."};const r={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"};var a=Object.freeze({SILENT:"silent",INVISIBLE:"invisible",FIXED:"fixed",QUIET:"quiet",SCENERY:"scenery"}),s={start:s=>{const{commands:u,aliases:c,baseCommandMap:d}=(i=>{const r=n({},e),a=n({},o);i.commands&&Object.entries(i.commands).forEach(([t,n])=>{r[t]=t,a[t]=n});const s=Object.entries(a).reduce((t,[n,e])=>(t[n]=n,e.forEach(e=>{t[e]=n}),t),{});return t.extend((t,n)=>{const e=Object.keys(s).reduce((t,n)=>(t[n]="Verb",t),{});n.addWords(e)}),{commands:r,aliases:a,baseCommandMap:s,nlp:t}})(s),{entities:p,startLocationId:l,getSubject:m}=(n=>{const e={};let o;const i=n.entities.reduce((t,r,a)=>{const s=r(()=>i[s.id]);if(!s.id)throw console.error(s),new Error("Missing entity id");return s.is=t=>s.id===t,s.exists=!0,s.meta={visitCount:0,isInitialState:!0,isExamined:!1},s.nouns&&s.nouns.forEach(t=>{if(t in e)throw new Error(`Duplicate noun '${t}' found for entity '${s.id}'`);e[t]=s.id}),s.data||(s.data={}),s.things||(s.things=[]),s.tags||(s.tags=[]),s.things=new Set(s.things),s.tags=new Set(s.tags),t[s.id]=s,0===a&&(o=n.startLocationId||s.id),t},{});return t.extend((t,n)=>{const o=Object.keys(e).reduce((t,n)=>(t[n]="Noun",t),{});n.addWords(o)}),{entities:i,baseNounMap:e,startLocationId:o,getSubject:(t,n,o=(()=>!0))=>{if(!(t in e))return!1;n instanceof Array||(n=[n]);const r=i[e[t]];let a=!1;return n.forEach(t=>{t.has(r.id)&&o(r)&&(a=r)}),a}}})(s),g=n({},i),I={turnCount:0,isActive:!0,currentLocationId:l,inventory:new Set(s.startInventory||[]),lastSubject:null},h=((t={})=>{const e=n({},r,t),o=Object.entries(e).reduce((t,[n,e])=>{const o=document.querySelector(e);if(!o)throw new Error(`No DOM element found for selector: ${e}`);return t[n]=o,t},{}),i=()=>o.inputField.value.trim();return{els:o,onSubmit:t=>{o.inputForm.addEventListener("submit",n=>{n.preventDefault(),t(i())})},getInput:i,clearInput:()=>{o.inputField.value=""},hideInput:()=>{o.inputForm.classList.add("hidden")},showInput:()=>{o.inputForm.classList.remove("hidden")},clearOutput:()=>{o.output.innerHTML=""},writeOutput:(t,n)=>{const e=document.createElement("p");e.innerHTML=t,n&&e.classList.add(n),o.output.appendChild(e)},scrollToBottom:()=>{window.scrollTo(0,document.body.scrollHeight)}}})(),f=(({UI:t,gameState:n})=>{const e=[];let o=!1;const i=()=>{if(o)return;if(0===e.length)return o=!1,void(n.isActive&&t.showInput());o=!0;const r=e.shift();if("pauseTime"in r)return void setTimeout(()=>{o=!1,i()},r.pauseTime);const{outputText:a,cssClass:s}=r;t.writeOutput(a,s),t.scrollToBottom(),o=!1,i()};return{add:t=>{e.push(t),i()}}})({UI:h,gameState:I});let T,v;const y={ALIASES:c,COMMANDS:u,clear(){h.clearOutput()},doTurn(){I.turnCount+=1},dyntext:t=>"function"==typeof t?t(y):t,end(){I.isActive=!1,h.hideInput()},entity(t){if(!p[t])throw new Error(`Game logic error: no entity '${t}' found`);return p[t]},goTo(t,n=!1){const e=y.entity(t);let o=!1,i=null;const r=()=>{o=!0},a=t=>{i=t};"function"==typeof s.onGoTo&&s.onGoTo({game:y,destination:e,stopGoTo:r,afterGoTo:a}),I.isActive&&!o&&("function"==typeof e.onGoTo&&e.onGoTo({game:y,stopGoTo:r,afterGoTo:a}),I.isActive&&!o&&(I.currentLocationId=t,y.location.meta.visitCount+=1,y.look(),n||y.doTurn(),"function"==typeof i&&i()))},get inventory(){return I.inventory},get location(){return p[I.currentLocationId]},look(t=!1){const n=t||1===y.location.meta.visitCount;if(y.print(n?y.location.description:y.location.summary),y.location.things.size>0){let t=[...y.location.things].map(t=>p[t]).filter(t=>!t.tags.has(a.INVISIBLE)&&!t.tags.has(a.SCENERY)&&!t.tags.has(a.SILENT));if(n){const n=t.filter(t=>t.meta.isInitialState&&t.initial);n.length>0&&n.forEach(t=>{y.print(t.initial)}),t=t.filter(t=>!n.includes(t))}if(t.length>0){const n=`${g.LOCATION_ITEMS_PREFIX}${t.map(t=>y.dyntext(t.summary)).join(", ")}.`;y.print(n)}}},MESSAGES:g,noTurn(){v=!1},pause(t=0){h.hideInput(),f.add({pauseTime:t})},print(t,n){t&&(t instanceof Array?t.forEach(t=>y.print(t,n)):f.add({outputText:y.dyntext(t),cssClass:n}))},get state(){return I},TAGS:a};h.onSubmit(n=>{n&&I.isActive&&(T=null,v=!0,y.print(n,"input"),h.clearInput(),(({inputText:n,API:e,baseCommandMap:o,entities:i,commands:r,gameState:s,getSubject:u,config:c,gameMessages:d,afterCommand:p})=>{const l=t(n.toLowerCase()),m=l.verbs().out("array")[0],g=l.nouns().out("array")[0];if(!(m in o))return e.print(d.FAIL_UNKNOWN),void e.noTurn();const I=o[m],h=u(g,[e.location.things,e.inventory],t=>!t.tags.has(a.INVISIBLE));if("function"==typeof c.onCommand){let t=!1;const n=(n=!1)=>{t=!0,n&&e.noTurn()},o=Object.keys(r).reduce((t,n)=>(t[n]=I===n,t),{});if(o._base=I,c.onCommand({command:o,subject:h||{is:()=>!1,exists:!1},game:e,stopCommand:n,afterCommand:p,noTurn:e.noTurn}),t)return}if(s.isActive)if(e.location.to&&I in e.location.to)e.goTo(e.location.to[I]);else switch(I){case r.n:case r.s:case r.e:case r.w:case r.up:case r.down:case r.in:case r.out:return void e.print(d.FAIL_NO_EXIT);case r.look:return e.look(!0),void e.noTurn();case r.examine:return h?(e.print(h.description),void(h.meta.isExamined=!0)):(e.print(d.FAIL_EXAMINE),void e.noTurn());case r.get:return!h||h.tags.has(a.SCENERY)||h.tags.has(a.FIXED)?(e.print(d.FAIL_GET),void e.noTurn()):e.inventory.has(h.id)?(e.print(d.FAIL_GET_OWNED),void e.noTurn()):(e.location.things.delete(h.id),e.inventory.add(h.id),h.meta.isInitialState=!1,void e.print(d.OK_GET));case r.drop:return h&&e.inventory.has(h.id)?h.tags.has(a.FIXED)?(e.print(d.FAIL_DROP),void e.noTurn()):(e.inventory.delete(h.id),e.location.things.add(h.id),h.meta.isInitialState=!1,void e.print(d.OK_DROP)):(e.print(d.FAIL_DROP_OWNED),void e.noTurn());case r.inventory:{if(0===e.inventory.size)return e.print(d.INV_NONE),void e.noTurn();const t=[...e.inventory].map(t=>i[t]).filter(t=>!t.tags.has(a.INVISIBLE)&&!t.tags.has(a.SILENT)).map(t=>e.dyntext(t.summary)).join(", ");return e.print(`${d.INV_PREFIX}${t}.`),void e.noTurn()}case r.help:return e.print(`Basic commands: ${Object.values(r).join(", ")}. Try other words too!`,"info"),void e.noTurn();default:e.print(d.FAIL_UNHANDLED),e.noTurn()}})({inputText:n,API:y,baseCommandMap:d,entities:p,commands:u,gameState:I,getSubject:m,config:s,gameMessages:g,afterCommand:t=>{T=t}}),I.isActive&&("function"==typeof T&&(T(),T=null),I.isActive&&v&&(y.doTurn(),"function"==typeof s.onTurn&&s.onTurn({game:y,turnCount:I.turnCount}))))}),h.clearOutput(),y.goTo(I.currentLocationId,!0)}};export{s as default};
//# sourceMappingURL=index.modern.js.map
