import t from"compromise";function n(){return n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var o=arguments[n];for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(t[e]=o[e])}return t},n.apply(this,arguments)}var o,e=function(t,n){return t.reduce(function(t,o){return t[o]=n(t,o),t},{})},i={n:"n",e:"e",w:"w",s:"s",up:"up",down:"down",in:"in",out:"out",look:"look",examine:"examine",get:"get",drop:"drop",inventory:"inventory",help:"help"},r=((o={})[i.n]=["north","go north"],o[i.e]=["east","go east"],o[i.w]=["west","go west"],o[i.s]=["south","go south"],o[i.up]=["u","go up","ascend"],o[i.down]=["d","go down","descend"],o[i.in]=["enter","go in","get in"],o[i.out]=["leave","go out","get out","exit"],o[i.look]=["look around","where","where am i","whereami"],o[i.examine]=["look at","inspect","x","ex","search","check"],o[i.get]=["g","take","pick up","obtain","acquire","grab"],o[i.drop]=["put down","toss","remove","discard"],o[i.inventory]=["inv","carrying","equipment","items","gear"],o[i.help]=["instructions","howto","how to play","?","commands","verbs","words","controls"],o),a={LOCATION_ITEMS_PREFIX:"You can see ",INV_PREFIX:"You are carrying ",INV_NONE:"You are carrying nothing.",FAIL_UNKNOWN:"Sorry, I don't understand.",FAIL_UNHANDLED:"Sorry, I can't do that.",FAIL_NO_EXIT:"You can't go that way.",FAIL_EXAMINE:"Sorry, I can't see that.",FAIL_GET:"Sorry, I can't get that.",FAIL_GET_OWNED:"You already seem to have that.",FAIL_DROP:"Sorry, I can't drop that.",FAIL_DROP_OWNED:"You don't seem to have that.",OK_GET:"Taken.",OK_DROP:"Dropped."},u={inputForm:".game-input",inputField:".game-typed-input",output:".game-output"},s=function(t){var n=t.UI,o=t.gameState,e=[],i=!1,r=function t(){if(!i){if(0===e.length)return i=!1,void(o.isActive&&n.showInput());i=!0;var r=e.shift();"pauseTime"in r?setTimeout(function(){i=!1,t()},r.pauseTime):(n.writeOutput(r.outputText,r.cssClass),n.scrollToBottom(),i=!1,t())}};return{add:function(t){e.push(t),r()}}},c=Object.freeze({FIXED:"fixed",INVISIBLE:"invisible",ITEM:"item",PRESENT:"present",SILENT:"silent"}),d=function(t,n){return t.map(function(t){return n.dyntext(t.summary)}).join(", ")},f=function(t){return t&&t.tags.has(c.ITEM)&&!t.tags.has(c.FIXED)&&!t.tags.has(c.INVISIBLE)},p={start:function(o){var p,m,l=function(o){var a=n({},i),u=n({},r);o.commands&&Object.entries(o.commands).forEach(function(t){var n=t[0],o=t[1];a[n]=n,u[n]=o});var s=e(Object.keys(u),function(t,n){return u[n].forEach(function(o){t[o]=n}),n});return t.extend(function(t,n){var o=e(Object.keys(s),function(){return"Verb"});n.addWords(o)}),{commands:a,aliases:u,baseCommandMap:s,nlp:t}}(o),v=l.commands,I=l.aliases,g=l.baseCommandMap,h=function(n){var o,i={},r=n.entities.reduce(function(t,e,a){var u=e(function(){return r[u.id]});if(!u.id)throw console.error(u),new Error("Missing entity id");return u.is=function(t){return u.id===t},u.exists=!0,u.meta={visitCount:0,isInitialState:!0,isExamined:!1},u.data||(u.data={}),u.things||(u.things=[]),u.tags||(u.tags=[]),u.things=new Set(u.things),u.tags=new Set(u.tags),u.nouns&&u.nouns.forEach(function(t){if(t in i)throw new Error("Duplicate noun '"+t+"' found for entity '"+u.id+"'");i[t]=u.id}),t[u.id]=u,0===a&&(o=n.startLocationId||u.id),t},{});return t.extend(function(t,n){var o=e(Object.keys(i),function(){return"Noun"});n.addWords(o)}),{entities:r,baseNounMap:i,startLocationId:o,getSubject:function(t,n,o){if(void 0===o&&(o=function(){return!0}),!(t in i))return!1;n instanceof Array||(n=[n]);var e=r[i[t]],a=!1;return n.forEach(function(t){t.has(e.id)&&o(e)&&(a=e)}),a}}}(o),y=h.entities,T=h.startLocationId,E=h.getSubject,L=n({},a),S={turnCount:0,isActive:!0,currentLocationId:T,inventory:new Set(o.startInventory||[]),lastSubject:null},N=function(t){void 0===t&&(t={});var o=n({},u,t),i=e(Object.keys(o),function(t,n){var e=o[n],i=document.querySelector(e);if(!i)throw new Error("No DOM element found for selector: "+e);return i}),r=function(){return i.inputField.value.trim()};return{els:i,onSubmit:function(t){i.inputForm.addEventListener("submit",function(n){n.preventDefault(),t(r())})},getInput:r,clearInput:function(){i.inputField.value=""},hideInput:function(){i.inputForm.classList.add("hidden")},showInput:function(){i.inputForm.classList.remove("hidden")},clearOutput:function(){i.output.innerHTML=""},writeOutput:function(t,n){var o=document.createElement("p");o.innerHTML=t,n&&o.classList.add(n),i.output.appendChild(o)},scrollToBottom:function(){window.scrollTo(0,document.body.scrollHeight)}}}(),O=s({UI:N,gameState:S}),A={ALIASES:I,COMMANDS:v,clear:function(){N.clearOutput()},doTurn:function(){S.turnCount+=1},dyntext:function(t){return"function"==typeof t?t(A):t},end:function(){S.isActive=!1,N.hideInput()},entity:function(t){if(!y[t])throw new Error("Game logic error: no entity '"+t+"' found");return y[t]},goTo:function(t,n){void 0===n&&(n=!1);var e=A.entity(t),i=!0;"function"==typeof o.onGoTo&&(i=o.onGoTo({game:A,destination:e})),!1!==i&&S.isActive&&("function"==typeof e.onGoTo&&(i=e.onGoTo({game:A})),!1!==i&&S.isActive&&(S.currentLocationId=t,A.location.meta.visitCount+=1,A.look(),n||A.doTurn(),"function"==typeof i&&i()))},get inventory(){return S.inventory},get location(){return y[S.currentLocationId]},look:function(t){void 0===t&&(t=!1);for(var n=A.location,e=t||1===n.meta.visitCount,i=!0,r=[o.onLook,n.onLook],a=0;a<2;a++){var u=r[a];if("function"==typeof u&&(!1===(i=u({game:A,isFullLook:e}))||!S.isActive))return}if(A.print(e?n.description:n.summary),0!==n.things.size){var s,f=function(t,n){return[].concat(t.things).map(function(t){return n[t]}).filter(function(t){return(t.tags.has(c.ITEM)||t.tags.has(c.PRESENT))&&!t.tags.has(c.INVISIBLE)&&!t.tags.has(c.SILENT)})}(n,y);if(e){var p=f.filter(function(t){return t.meta.isInitialState&&t.initial});p.length>0&&(p.forEach(function(t){A.print(t.initial)}),s=p,f=f.filter(function(t){return!s.includes(t)}))}if(0!==f.length){var m=""+L.LOCATION_ITEMS_PREFIX+d(f,A)+".";A.print(m),"function"==typeof i&&i()}else"function"==typeof i&&i()}else"function"==typeof i&&i()},MESSAGES:L,noTurn:function(){m=!1},pause:function(t){void 0===t&&(t=0),N.hideInput(),O.add({pauseTime:t})},print:function(t,n){t&&(t instanceof Array?t.forEach(function(t){return A.print(t,n)}):O.add({outputText:A.dyntext(t),cssClass:n}))},get state(){return S},TAGS:c};N.onSubmit(function(n){n&&S.isActive&&(p=null,m=!0,A.print(n,"input"),N.clearInput(),function(n){var o=n.API,i=n.baseCommandMap,r=n.entities,a=n.commands,u=n.gameState,s=n.getSubject,p=n.config,m=n.gameMessages,l=n.afterCommand,v=t(n.inputText.toLowerCase()),I=v.verbs().out("array")[0],g=v.nouns().out("array")[0];if(!(I in i))return o.print(m.FAIL_UNKNOWN),void o.noTurn();var h=i[I],y=s(g,[o.location.things,o.inventory],function(t){return!t.tags.has(c.INVISIBLE)});if("function"==typeof p.onCommand){var T,E=e(Object.keys(a),function(t,n){return h===n});if(E._base=h,!1===(T=p.onCommand({command:E,subject:y||{is:function(){return!1},exists:!1},game:o,noTurn:o.noTurn}))||!u.isActive)return;"function"==typeof T&&l(T)}if(o.location.to&&h in o.location.to)o.goTo(o.location.to[h]);else switch(h){case a.n:case a.s:case a.e:case a.w:case a.up:case a.down:case a.in:case a.out:return void o.print(m.FAIL_NO_EXIT);case a.look:return o.look(!0),void o.noTurn();case a.examine:return y?(o.print(y.description),void(y.meta.isExamined=!0)):(o.print(m.FAIL_EXAMINE),void o.noTurn());case a.get:return f(y)?o.inventory.has(y.id)?(o.print(m.FAIL_GET_OWNED),void o.noTurn()):(o.location.things.delete(y.id),o.inventory.add(y.id),y.meta.isInitialState=!1,void o.print(m.OK_GET)):(o.print(m.FAIL_GET),void o.noTurn());case a.drop:return y&&o.inventory.has(y.id)?f(y)?(o.inventory.delete(y.id),o.location.things.add(y.id),y.meta.isInitialState=!1,void o.print(m.OK_DROP)):(o.print(m.FAIL_DROP),void o.noTurn()):(o.print(m.FAIL_DROP_OWNED),void o.noTurn());case a.inventory:if(0===o.inventory.size)return o.print(m.INV_NONE),void o.noTurn();var L=function(t,n){return[].concat(n.inventory).map(function(n){return t[n]}).filter(function(t){return!t.tags.has(c.INVISIBLE)&&!t.tags.has(c.SILENT)})}(r,o),S=d(L,o);return o.print(""+m.INV_PREFIX+S+"."),void o.noTurn();case a.help:return o.print("Basic commands: "+Object.values(a).join(", ")+". Try other words too!","info"),void o.noTurn();default:o.print(m.FAIL_UNHANDLED),o.noTurn()}}({inputText:n,API:A,baseCommandMap:g,entities:y,commands:v,gameState:S,getSubject:E,config:o,gameMessages:L,afterCommand:function(t){p=t}}),S.isActive&&("function"==typeof p&&(p(),p=null),S.isActive&&m&&(A.doTurn(),"function"==typeof o.onTurn&&o.onTurn({game:A,turnCount:S.turnCount}))))}),N.clearOutput(),A.goTo(S.currentLocationId,!0)}};export{p as default};
//# sourceMappingURL=index.esm.js.map
